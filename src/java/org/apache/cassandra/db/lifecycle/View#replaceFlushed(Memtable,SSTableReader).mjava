    // called after flush: removes memtable from flushingMemtables, and inserts flushed into the live sstable set
    static Function<View, View> replaceFlushed(final Memtable memtable, final SSTableReader flushed)
    {
        return new Function<View, View>()
        {
            public View apply(View view)
            {
                List<Memtable> flushingMemtables = copyOf(filter(view.flushingMemtables, not(equalTo(memtable))));
                assert flushingMemtables.size() == view.flushingMemtables.size() - 1;

                if (flushed == null)
                    return new View(view.liveMemtables, flushingMemtables, view.sstablesMap,
                                    view.compacting, view.premature, view.intervalTree);

                Map<SSTableReader, SSTableReader> sstableMap = replace(view.sstablesMap, emptySet(), singleton(flushed));
                Set<SSTableReader> compacting = replace(view.compacting, emptySet(), singleton(flushed));
                Set<SSTableReader> premature = replace(view.premature, emptySet(), singleton(flushed));
                return new View(view.liveMemtables, flushingMemtables, sstableMap, compacting, premature,
                                SSTableIntervalTree.build(sstableMap.keySet()));
            }
        };
    }


    public void replaceFlushed(Memtable memtable, SSTableReader sstable)
    {
        assert !isDummy();
        if (sstable == null)
        {
            // sstable may be null if we flushed batchlog and nothing needed to be retained
            // if it's null, we don't care what state the cfstore is in, we just replace it and continue
            apply(View.replaceFlushed(memtable, null));
            return;
        }

        sstable.setupKeyCache();
        // back up before creating a new Snapshot (which makes the new one eligible for compaction)
        maybeIncrementallyBackup(sstable);

        apply(View.replaceFlushed(memtable, sstable));

        Throwable fail;
        fail = updateSizeTracking(emptySet(), singleton(sstable), null);

        maybeFail(fail);
    }


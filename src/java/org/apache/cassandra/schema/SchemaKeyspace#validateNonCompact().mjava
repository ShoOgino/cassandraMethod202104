    public static void validateNonCompact() throws StartupException
    {
        String query = String.format("SELECT keyspace_name, table_name, flags FROM %s.%s", SchemaConstants.SCHEMA_KEYSPACE_NAME, TABLES);

        StringBuilder messages = new StringBuilder();
        for (UntypedResultSet.Row row : query(query))
        {
            if (SchemaConstants.isLocalSystemKeyspace(row.getString("keyspace_name")))
                continue;

            Set<String> flags = row.getFrozenSet("flags", UTF8Type.instance);
            if (TableMetadata.Flag.isLegacyCompactTable(TableMetadata.Flag.fromStringSet(flags)))
            {
                messages.append(String.format("ALTER TABLE %s.%s DROP COMPACT STORAGE;\n",
                                              maybeQuote(row.getString("keyspace_name")),
                                              maybeQuote(row.getString("table_name"))));
            }
        }

        if (messages.length() != 0)
        {
            throw new StartupException(StartupException.ERR_OUTDATED_SCHEMA,
                                       String.format("Compact Tables are not allowed in Cassandra starting with 4.0 version. " +
                                                     "In order to migrate off Compact Storage, downgrade to the latest Cassandra version, " +
                                                     "and run the following CQL commands: \n\n%s\n" +
                                                     "Then restart the node with the new Cassandra version.",
                                                     messages));
        }
    }

